# Extracting BUSCOs using coordinates from genomes aligned to the same reference genome

# Originally written by Chad Eliason and adapted by Jenna McCullough
# 15 December 2023 

# This was written to extract BUSCO loci out of resequenced whole genomes that are 
# all aligned to the same reference genome of a Todiramphus chloris (TodChl). 

cd ~/uce-alcedinidae/busco

# Run BUSCO on the reference genome that has been indexed already
REF=~/Storage/celiason_Phoebe/todi/ref_genome/todChl.scaffolds.full_mask.fa
busco -c 20 -i ${REF} -m genome -l aves -o=todChl_redo

cd todChl_redo

# Now we need to convert metaeuk "GFF" to something sensible
# the format output by the program doesn't work with gffread pipeline
# Download script to convert metaeuk output to a GFF3 file-
curl https://raw.githubusercontent.com/Andy-B-123/MetaeukToGff3/main/MetaeukToGff3.py

# feel free to rename test.gff3 to something more informative...
python MetaeukToGff3.py -f todChl_redo/run_aves_odb10/metaeuk_output/initial_results/todChl.scaffolds.full_mask.fa.fas -g test.gff3

# Extract metaeuk genes for each species using the GFF file we just generated
mkdir busco_output_fas
for f in `ls ~/Storage/celiason_Phoebe/todi/genomes/*con.masked.fa`
do
	nm=`basename ${f} .con.masked.fa`
	echo Working on $nm
	gffread -g ${f} -y busco_output_fas/${nm}.faa test.gff3
done

# Create a list of specimens from the FASTAs
find busco_output_fas -name '*.faa' | xargs -I{} basename {} ".faa" > specimen_list.txt

# Get the list of BUSCO IDs for subsetting (metaeuk seems to give lots of genes, full_table has the BUSCOs)
awk 'NR>3 {print $1}' todChl_redo/run_aves_odb10/full_table.tsv > busco_ids.txt

# Append specimen/species names to FASTA sequence headers (for later)
for sp in `cat specimen_list.txt`
do
	sed '/^>/s/ *$/ '${sp}'/g' busco_output_fas/${sp}.faa > busco_output_fas/${sp}_renamed.faa
done

# Combine all BUSCOs into a really big FASTA
cat busco_output_fas/00_busco_output_fas/*_renamed.faa > busco_output_fas/todi103_all.faa

# Rename headers (remove extra stuff, keeping only BUSCO IDs)
sed -r 's/_.+mRNA//g' busco_output_fas/todi103_all.faa > busco_output_fas/todi103_all_renamed.faa

# Pull out alignments for each BUSCO (e.g., for phylogenetics, etc.)
# conda install -c bioconda ucsc-faSomeRecords
mkdir busco_output_fas/01_alignments
for loci in `cat busco_ids.txt`
do
	echo ${loci} > ID.txt
	faSomeRecords busco_output_fas/todi103_all_renamed.faa ID.txt busco_output_fas/01_alignments/${loci}.faa
done
